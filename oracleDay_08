-----day08

--부서별 평균 급여 조회 (부서이름, 평균급여)
SELECT D.DNAME, AVG(E.SAL)
FROM EMP E INNER JOIN DEPT D ON E.DEPTNO = D.DEPTNO
GROUP BY D.DNAME;

SELECT DEPTNO, AVG(SAL)
FROM EMP
GROUP BY DEPTNO;

-- 직원이름, 급여, 부서별 평균
-- SMITH   800    2258
-- ALLEN   1600   1566

--1. EMP 부서별 평균 급여 조회
SELECT DEPTNO, AVG(SAL)
FROM EMP
GROUP BY DEPTNO;
--2. EMP테이블과 1번의 SELECT문 결과를 조인
SELECT E1.ENAME, E1.SAL, E2.DEPTNO, E2.DEPTAVG
FROM EMP E1 INNER JOIN (SELECT DEPTNO, AVG(SAL) AS DEPTAVG FROM EMP GROUP BY DEPTNO) E2 ON E1.DEPTNO = E2.DEPTNO;
--WHERE E1.ENAME = 'SMITH';

--3. DEPTNO 대신 ENAME(부서이름)으로 출력
SELECT E1.ENAME, E1.SAL, E2.DEPTAVG
FROM EMP E1 INNER JOIN (SELECT DEPTNO, AVG(SAL) AS DEPTAVG FROM EMP GROUP BY DEPTNO) E2 
                        ON E1.DEPTNO = E2.DEPTNO INNER JOIN DEPT D ON E1.DEPTNO = D.DEPTNO;
                        
-- 직원이름(ENAME), 직무(JOB), 직무별 인원수
--1. 직무별 인원수 조회
SELECT JOB, COUNT(*)
FROM EMP
GROUP BY JOB;
--2. EMP테이블 1번 결과를 조인
SELECT E1.ENAME, E1.JOB, E2.JCOUNT
FROM EMP E1, (SELECT JOB, COUNT(*) AS JCOUNT FROM EMP GROUP BY JOB) E2
WHERE E1.JOB = E2.JOB;

-- ROWNUM
SELECT ROWNUM, EMP.*
FROM EMP;

--1.
SELECT ROWNUM AS SALRANK, EMP.*
FROM EMP
ORDER BY SAL DESC;

--2.
SELECT ROWNUM AS SALRANK, EMP.*
FROM (SELECT * FROM EMP ORDER BY SAL DESC) EMP;

--3.
SELECT *
FROM (SELECT ROWNUM AS SALRANK, EMP.* FROM (SELECT * FROM EMP ORDER BY SAL DESC) EMP)
WHERE ENAME = 'SMITH'; -- SMITH의 SAL순위

-- VIEW(가상테이블)
-- CREATE VIEW
CREATE OR REPLACE VIEW SALRANK_EMP
AS ( SELECT ROWNUM AS SALRANK, EMP.* 
     FROM (SELECT * FROM EMP ORDER BY SAL DESC) EMP ); -- 3.

SELECT *
FROM SALRANK_EMP
WHERE ENAME = 'SMITH';
;

/*
UPDATE 테이블명
SET 컬럼명 = 수정할 값
WHERE 데이터를 수정할 레코드
*/
--JAMES'의 급여를 1000으로 수정(WHERE절로 바꿀값 선별-안하면 모든값 바뀜)
UPDATE EMP
SET SAL = 1000
WHERE ENAME = 'JAMES';

--JAMES'의 급여를 100 증가
UPDATE EMP
SET SAL = SAL + 100
WHERE ENAME = 'JAMES';
SELECT * FROM EMP;

-- MGR 이 'BLAKE'인 직원들의 급여를 200증가
UPDATE EMP
SET SAL = SAL + 200
WHERE MGR = (SELECT EMPNO FROM EMP WHERE ENAME = 'BLAKE');

SELECT *
FROM SALRANK_EMP;

-- DELETE
/*
DELETE FROM 테이블명
WHERE 삭제할 레코드를 선별
*/
-- 급여를 가장 적게 받는 직원이 근무하는 부서의 직원들을 모두 삭제
--1. 급여의 최소값(MIN(SAL)) 조회 : 800
SELECT MIN(SAL)
FROM EMP;
--2. 급여가 MIN(SAL)인 직원의 부서번호 조회 : 20
SELECT DEPTNO
FROM EMP
WHERE SAL = (SELECT MIN(SAL) FROM EMP);

--3. 해당 부서의 직원정보 삭제
DELETE FROM EMP
WHERE DEPTNO = (SELECT DEPTNO
                FROM EMP
                WHERE SAL = (SELECT MIN(SAL) FROM EMP));
SELECT * FROM EMP;
ROLLBACK;

-- 'ALLEN'의 부서번호를 50번으로 수정
UPDATE EMP
SET DEPTNO = 50
WHERE ENAME = 'ALLEN'; 
-- ORA-02291: 무결성 제약조건(JGH_DBA.FK_DEPTNO)이 위배되었습니다- 부모 키가 없습니다
SELECT * FROM DEPT; -- EMP의 DEPTNO은 DEPT에 DEOTNO울 참조하고 있어서 오류(DEOTNO = 10,20,30,40)

DELETE FROM DEPT
WHERE DEPTNO = 30;
-- ORA-02292: 무결성 제약조건(JGH_DBA.FK_DEPTNO)이 위배되었습니다- 자식 레코드가 발견되었습니다
